name: CI/CD - Tech Challenge

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build-test:
    name: ğŸ§ª Build e Testes
    runs-on: ubuntu-latest

    services:
      mysql:
        image: bitnami/mysql:8.4
        ports:
          - 3306:3306
        env:
          MYSQL_DATABASE: SchoolOnDb
          #MYSQL_USER: root
          #MYSQL_PASSWORD: senha123
          MYSQL_ROOT_PASSWORD: senha123
        options: --health-cmd="mysqladmin ping --silent" --health-interval=10s --health-timeout=5s --health-retries=5

    env:
      NODE_ENV: test
      DATABASE_USERNAME: root
      DATABASE_PASSWORD: senha123
      DATABASE_HOST: 127.0.0.1
      DATABASE_PORT: 3306
      PORT: 3000

    steps:
      - name: ğŸ“¥ Clonar repositÃ³rio
        uses: actions/checkout@v3

      - name: ğŸŸ¢ Configurar Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: ğŸ“¦ Instalar dependÃªncias
        run: npm install

      - name: ğŸ› ï¸ Rodar Migrations
        run: npx sequelize-cli db:migrate --env test --config ./src/database/config.js --migrations-path ./src/database/migrations

      - name: ğŸ§ª Executar Testes e Cobertura
        run: npm test -- --coverage

      - name: ğŸš¨ Validar Cobertura mÃ­nima
        run: |
          COVERAGE=$(npx jest --coverage | grep 'All files' | awk '{print $5}' | tr -d '%')
          echo "Cobertura atual: $COVERAGE%"
          if (( $(echo "$COVERAGE < 20" | bc -l) )); then
            echo "âŒ Cobertura abaixo de 20%! Falha na pipeline."
            exit 1
          fi
